<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WAR Lab HR Analytics V2</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
    <style>
        :root {
            --bg-primary: #0f1923;
            --bg-secondary: #162029;
            --bg-card: #1a2937;
            --bg-hover: #213343;
            --accent-blue: #3b82f6;
            --accent-cyan: #06b6d4;
            --accent-emerald: #10b981;
            --accent-amber: #f59e0b;
            --accent-rose: #f43f5e;
            --accent-violet: #8b5cf6;
            --text-primary: #e2e8f0;
            --text-secondary: #94a3b8;
            --text-muted: #64748b;
            --border: #1e3a4f;
            --shadow: rgba(0,0,0,0.3);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: var(--bg-primary); color: var(--text-primary); min-height: 100vh; }

        /* Header */
        .header { background: var(--bg-secondary); border-bottom: 1px solid var(--border); padding: 16px 32px; display: flex; align-items: center; justify-content: space-between; position: sticky; top: 0; z-index: 100; }
        .header-left { display: flex; align-items: center; gap: 16px; }
        .header h1 { font-size: 20px; font-weight: 600; color: var(--text-primary); }
        .header h1 span { color: var(--accent-cyan); }
        .version-badge { background: var(--accent-blue); color: white; padding: 2px 10px; border-radius: 12px; font-size: 11px; font-weight: 600; }
        .header-right { display: flex; align-items: center; gap: 16px; font-size: 13px; color: var(--text-secondary); }
        .live-dot { width: 8px; height: 8px; background: var(--accent-emerald); border-radius: 50%; display: inline-block; animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.4; } }

        /* Navigation */
        .nav { display: flex; gap: 4px; padding: 8px 32px; background: var(--bg-secondary); border-bottom: 1px solid var(--border); position: sticky; top: 57px; z-index: 99; }
        .nav-tab { padding: 8px 20px; border-radius: 8px; cursor: pointer; font-size: 13px; font-weight: 500; color: var(--text-secondary); background: transparent; border: none; transition: all 0.2s; }
        .nav-tab:hover { color: var(--text-primary); background: var(--bg-hover); }
        .nav-tab.active { color: var(--accent-cyan); background: rgba(6,182,212,0.1); }

        /* Content */
        .content { padding: 24px 32px; max-width: 1600px; margin: 0 auto; }
        .tab-panel { display: none; }
        .tab-panel.active { display: block; }

        /* KPI Cards */
        .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 16px; margin-bottom: 24px; }
        .kpi-card { background: var(--bg-card); border-radius: 12px; padding: 20px; border: 1px solid var(--border); transition: transform 0.2s, border-color 0.2s; }
        .kpi-card:hover { transform: translateY(-2px); border-color: var(--accent-cyan); }
        .kpi-label { font-size: 12px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px; }
        .kpi-value { font-size: 28px; font-weight: 700; color: var(--text-primary); }
        .kpi-sub { font-size: 12px; color: var(--text-secondary); margin-top: 4px; }

        /* Chart Grid */
        .chart-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; }
        .chart-grid.single { grid-template-columns: 1fr; }
        .chart-card { background: var(--bg-card); border-radius: 12px; padding: 20px; border: 1px solid var(--border); }
        .chart-title { font-size: 14px; font-weight: 600; color: var(--text-primary); margin-bottom: 16px; display: flex; align-items: center; gap: 8px; }
        .chart-title .icon { width: 20px; height: 20px; border-radius: 6px; display: flex; align-items: center; justify-content: center; font-size: 11px; }
        .chart-container { width: 100%; height: 350px; }
        .chart-container.tall { height: 450px; }

        /* Responsive */
        @media (max-width: 768px) {
            .chart-grid { grid-template-columns: 1fr; }
            .kpi-grid { grid-template-columns: repeat(2, 1fr); }
            .content { padding: 16px; }
        }

        /* Loading */
        .loading { display: flex; align-items: center; justify-content: center; height: 300px; color: var(--text-muted); }
        .loading::after { content: ''; width: 24px; height: 24px; border: 2px solid var(--border); border-top-color: var(--accent-cyan); border-radius: 50%; animation: spin 0.8s linear infinite; margin-left: 12px; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-left">
            <h1>WAR Lab <span>HR Analytics</span></h1>
            <span class="version-badge">V2</span>
        </div>
        <div class="header-right">
            <span><span class="live-dot"></span> Live</span>
            <span id="timestamp"></span>
        </div>
    </div>

    <nav class="nav">
        <button class="nav-tab active" data-tab="overview">Overview</button>
        <button class="nav-tab" data-tab="headcount">Headcount</button>
        <button class="nav-tab" data-tab="movements">Movements</button>
        <button class="nav-tab" data-tab="compensation">Compensation</button>
        <button class="nav-tab" data-tab="orghealth">Org Health</button>
    </nav>

    <div class="content">
        <!-- Overview Tab -->
        <div id="tab-overview" class="tab-panel active">
            <div class="kpi-grid" id="kpi-cards"></div>
            <div class="chart-grid">
                <div class="chart-card"><div class="chart-title">Headcount Trend (24 Months)</div><div id="chart-hc-trend" class="chart-container"></div></div>
                <div class="chart-card"><div class="chart-title">Monthly Movements</div><div id="chart-mv-overview" class="chart-container"></div></div>
            </div>
        </div>

        <!-- Headcount Tab -->
        <div id="tab-headcount" class="tab-panel">
            <div class="kpi-grid" id="hc-kpi-cards"></div>
            <div class="chart-grid">
                <div class="chart-card"><div class="chart-title">Headcount by Company</div><div id="chart-hc-company" class="chart-container"></div></div>
                <div class="chart-card"><div class="chart-title">Headcount by Location</div><div id="chart-hc-location" class="chart-container"></div></div>
                <div class="chart-card" style="grid-column: span 2;"><div class="chart-title">Top 20 Departments by Headcount</div><div id="chart-hc-dept" class="chart-container tall"></div></div>
                <div class="chart-card" style="grid-column: span 2;"><div class="chart-title">Headcount Growth Trend</div><div id="chart-hc-trend2" class="chart-container"></div></div>
            </div>
        </div>

        <!-- Movements Tab -->
        <div id="tab-movements" class="tab-panel">
            <div class="kpi-grid" id="mv-kpi-cards"></div>
            <div class="chart-grid">
                <div class="chart-card"><div class="chart-title">Movement Types</div><div id="chart-mv-types" class="chart-container"></div></div>
                <div class="chart-card"><div class="chart-title">Termination Reasons</div><div id="chart-mv-terms" class="chart-container"></div></div>
                <div class="chart-card" style="grid-column: span 2;"><div class="chart-title">Monthly Hires vs Terminations</div><div id="chart-mv-trend" class="chart-container"></div></div>
                <div class="chart-card" style="grid-column: span 2;"><div class="chart-title">Turnover & Promotion Rates (%)</div><div id="chart-mv-rates" class="chart-container"></div></div>
            </div>
        </div>

        <!-- Compensation Tab -->
        <div id="tab-compensation" class="tab-panel">
            <div class="kpi-grid" id="comp-kpi-cards"></div>
            <div class="chart-grid">
                <div class="chart-card" style="grid-column: span 2;"><div class="chart-title">Average Pay by Job Family</div><div id="chart-comp-family" class="chart-container tall"></div></div>
                <div class="chart-card" style="grid-column: span 2;"><div class="chart-title">Compensation by Grade (Min / Avg / Max)</div><div id="chart-comp-grade" class="chart-container tall"></div></div>
            </div>
        </div>

        <!-- Org Health Tab -->
        <div id="tab-orghealth" class="tab-panel">
            <div class="chart-grid">
                <div class="chart-card"><div class="chart-title">Top 20 Departments by Size</div><div id="chart-org-depts" class="chart-container tall"></div></div>
                <div class="chart-card"><div class="chart-title">Manager Span of Control</div><div id="chart-org-span" class="chart-container tall"></div></div>
                <div class="chart-card"><div class="chart-title">Worker Distribution by Location</div><div id="chart-org-locs" class="chart-container"></div></div>
                <div class="chart-card"><div class="chart-title">Worker Status Distribution</div><div id="chart-org-status" class="chart-container"></div></div>
            </div>
        </div>
    </div>

<script>
// ============================================================
// Configuration
// ============================================================
const CONFIG = {
    dataEndpoint: '/v2/data/',
    refreshInterval: 300000,
    charts: {},
    colors: ['#3b82f6','#06b6d4','#10b981','#f59e0b','#f43f5e','#8b5cf6','#ec4899','#14b8a6','#f97316','#6366f1','#84cc16','#e879f9','#22d3ee','#fb923c','#a78bfa']
};

const dashboardData = { kpiSummary: null, headcount: null, movements: null, compensation: null, orgHealth: null };

// ============================================================
// Data Loading
// ============================================================
async function loadData() {
    const files = ['kpi_summary','headcount','movements','compensation','org_health'];
    const promises = files.map(f =>
        fetch(CONFIG.dataEndpoint + f + '.json')
            .then(r => r.ok ? r.json() : null)
            .catch(() => null)
    );
    const results = await Promise.all(promises);
    dashboardData.kpiSummary = results[0]?.data || results[0]?.metrics || null;
    dashboardData.headcount = results[1]?.data || null;
    dashboardData.movements = results[2]?.data || null;
    dashboardData.compensation = results[3]?.data || null;
    dashboardData.orgHealth = results[4]?.data || null;

    if (!dashboardData.kpiSummary) loadDemoData();
    renderAll();
}

function loadDemoData() {
    dashboardData.kpiSummary = { total_headcount: 20804, total_movements: 117094, avg_base_pay: 95000, active_companies: 8, active_departments: 144 };
    const months = [];
    for (let i = 23; i >= 0; i--) {
        const d = new Date(2026, 1 - i, 0);
        const m = d.toISOString().slice(0,7);
        months.push({ snapshot_date: d.toISOString().slice(0,10), month: m, headcount: Math.round(18200 + (23-i)*113 + Math.random()*200) });
    }
    dashboardData.headcount = {
        by_company: [{company_name:'WAR Lab US',headcount:8200},{company_name:'WAR Lab Tech',headcount:4100},{company_name:'WAR Lab Capital',headcount:3500},{company_name:'WAR Lab WM',headcount:2800},{company_name:'WAR Lab Insurance',headcount:1200},{company_name:'WAR Lab Canada',headcount:580},{company_name:'WAR Lab Holdings',headcount:320},{company_name:'WAR Lab US Advisory',headcount:104}],
        by_department: Array.from({length:20}, (_,i) => ({department_name:`Department ${i+1}`,headcount:Math.round(1200-i*55+Math.random()*50)})),
        by_location: [{location_name:'New York',headcount:5200},{location_name:'Toronto',headcount:3800},{location_name:'Chicago',headcount:2900},{location_name:'San Francisco',headcount:2100},{location_name:'London',headcount:1800},{location_name:'Boston',headcount:1500},{location_name:'Dallas',headcount:1200},{location_name:'Montreal',headcount:900},{location_name:'Atlanta',headcount:700},{location_name:'Seattle',headcount:500}],
        trend: months
    };
    dashboardData.movements = {
        by_type: {hires:20804,terminations:10697,promotions:7833,demotions:380,lateral_moves:4835,job_changes:10615,pay_changes:45393,voluntary_terminations:6265,involuntary_terminations:2625,regrettable_terminations:6265,grade_changes:3200,company_changes:850,org_changes:1200,work_model_changes:420},
        terminations: [{primary_termination_reason:'VOL-BETTER_OPP',cnt:2871},{primary_termination_reason:'TER-RET',cnt:1298},{primary_termination_reason:'INV-PERFORMANCE',cnt:1125},{primary_termination_reason:'VOL-CAREER_CHG',cnt:1090},{primary_termination_reason:'VOL-COMPENSATION',cnt:920},{primary_termination_reason:'VOL-RELOCATION',cnt:779},{primary_termination_reason:'VOL-PERSONAL',cnt:741},{primary_termination_reason:'INV-RESTRUCTURE',cnt:693}],
        monthly_trend: months.map(m => ({month:m.month,hires:Math.round(800+Math.random()*200),terminations:Math.round(400+Math.random()*150),promotions:Math.round(300+Math.random()*100),job_changes:Math.round(400+Math.random()*150)})),
        rates: months.map(m => ({month:m.month,turnover_rate:(2+Math.random()*1.5).toFixed(2),promotion_rate:(1.2+Math.random()*0.8).toFixed(2)}))
    };
    dashboardData.compensation = {
        by_grade: Array.from({length:15}, (_,i) => ({grade_name:`Grade ${15-i}`,avg_pay:Math.round(180000-i*9000),min_pay:Math.round(140000-i*8000),max_pay:Math.round(220000-i*10000),worker_count:Math.round(500+Math.random()*1500)})),
        by_job_family: Array.from({length:15}, (_,i) => ({job_family:`Job Family ${i+1}`,avg_pay:Math.round(150000-i*6000),worker_count:Math.round(300+Math.random()*800)}))
    };
    dashboardData.orgHealth = {
        departments: Array.from({length:20}, (_,i) => ({department_name:`Dept ${i+1}`,worker_count:Math.round(1200-i*55)})),
        span_distribution: [{span_range:'1-3',manager_count:450},{span_range:'4-6',manager_count:820},{span_range:'7-10',manager_count:560},{span_range:'11-15',manager_count:180},{span_range:'16+',manager_count:40}],
        locations: dashboardData.headcount?.by_location || [],
        worker_status: [{worker_status:'Active',worker_count:18500},{worker_status:'On Leave',worker_count:1600},{worker_status:'Terminated',worker_count:994}]
    };
}

// ============================================================
// Rendering
// ============================================================
function renderAll() {
    renderOverview();
    renderHeadcount();
    renderMovements();
    renderCompensation();
    renderOrgHealth();
}

function fmt(n) {
    if (n == null) return '—';
    if (n >= 1e6) return (n/1e6).toFixed(1) + 'M';
    if (n >= 1e3) return (n/1e3).toFixed(n >= 1e4 ? 0 : 1) + 'K';
    return n.toLocaleString();
}
function fmtPay(n) { return n ? '$' + Math.round(n).toLocaleString() : '—'; }

function makeChart(id, option) {
    const el = document.getElementById(id);
    if (!el) return;
    if (CONFIG.charts[id]) CONFIG.charts[id].dispose();
    const chart = echarts.init(el);
    option.backgroundColor = 'transparent';
    option.textStyle = { color: '#94a3b8' };
    chart.setOption(option);
    CONFIG.charts[id] = chart;
}

function kpiCard(label, value, sub) {
    return `<div class="kpi-card"><div class="kpi-label">${label}</div><div class="kpi-value">${value}</div>${sub ? `<div class="kpi-sub">${sub}</div>` : ''}</div>`;
}

// ---- Overview ----
function renderOverview() {
    const k = dashboardData.kpiSummary;
    if (!k) return;
    document.getElementById('kpi-cards').innerHTML = [
        kpiCard('Active Headcount', fmt(k.total_headcount)),
        kpiCard('Total Movements', fmt(k.total_movements)),
        kpiCard('Avg Base Pay', fmtPay(k.avg_base_pay)),
        kpiCard('Companies', k.active_companies),
        kpiCard('Departments', k.active_departments),
    ].join('');

    const hc = dashboardData.headcount;
    if (hc?.trend) {
        const dates = hc.trend.map(r => r.snapshot_date?.slice(0,7) || r.month);
        const vals = hc.trend.map(r => parseInt(r.headcount));
        makeChart('chart-hc-trend', {
            tooltip: { trigger: 'axis' },
            xAxis: { type: 'category', data: dates, axisLabel: { color: '#64748b', rotate: 45 } },
            yAxis: { type: 'value', axisLabel: { color: '#64748b' }, splitLine: { lineStyle: { color: '#1e3a4f' } } },
            series: [{ type: 'line', data: vals, smooth: true, areaStyle: { color: new echarts.graphic.LinearGradient(0,0,0,1,[{offset:0,color:'rgba(6,182,212,0.3)'},{offset:1,color:'rgba(6,182,212,0)'}]) }, lineStyle: { color: '#06b6d4', width: 2 }, itemStyle: { color: '#06b6d4' } }],
            grid: { left: 60, right: 20, bottom: 60, top: 20 }
        });
    }

    const mv = dashboardData.movements;
    if (mv?.monthly_trend) {
        const months = mv.monthly_trend.map(r => r.month);
        makeChart('chart-mv-overview', {
            tooltip: { trigger: 'axis' },
            legend: { data: ['Hires','Terminations','Promotions'], textStyle: { color: '#94a3b8' }, top: 0 },
            xAxis: { type: 'category', data: months, axisLabel: { color: '#64748b', rotate: 45 } },
            yAxis: { type: 'value', axisLabel: { color: '#64748b' }, splitLine: { lineStyle: { color: '#1e3a4f' } } },
            series: [
                { name: 'Hires', type: 'bar', stack: 'flow', data: mv.monthly_trend.map(r => parseInt(r.hires||0)), itemStyle: { color: '#10b981' } },
                { name: 'Terminations', type: 'bar', stack: 'flow', data: mv.monthly_trend.map(r => -parseInt(r.terminations||0)), itemStyle: { color: '#f43f5e' } },
                { name: 'Promotions', type: 'line', data: mv.monthly_trend.map(r => parseInt(r.promotions||0)), lineStyle: { color: '#f59e0b' }, itemStyle: { color: '#f59e0b' } },
            ],
            grid: { left: 60, right: 20, bottom: 60, top: 40 }
        });
    }
}

// ---- Headcount ----
function renderHeadcount() {
    const hc = dashboardData.headcount;
    if (!hc) return;
    const k = dashboardData.kpiSummary || {};
    document.getElementById('hc-kpi-cards').innerHTML = [
        kpiCard('Active Headcount', fmt(k.total_headcount)),
        kpiCard('Companies', k.active_companies),
        kpiCard('Departments', k.active_departments),
        kpiCard('Locations', hc.by_location?.length || '—'),
    ].join('');

    if (hc.by_company) {
        makeChart('chart-hc-company', {
            tooltip: { trigger: 'axis' },
            xAxis: { type: 'category', data: hc.by_company.map(r => r.company_name || r.company_id), axisLabel: { color: '#64748b', rotate: 30, interval: 0 } },
            yAxis: { type: 'value', axisLabel: { color: '#64748b' }, splitLine: { lineStyle: { color: '#1e3a4f' } } },
            series: [{ type: 'bar', data: hc.by_company.map((r,i) => ({value: parseInt(r.headcount), itemStyle: {color: CONFIG.colors[i%CONFIG.colors.length]}})), barMaxWidth: 50 }],
            grid: { left: 60, right: 20, bottom: 80, top: 20 }
        });
    }

    if (hc.by_location) {
        makeChart('chart-hc-location', {
            tooltip: { trigger: 'item' },
            series: [{ type: 'pie', radius: ['35%','65%'], data: hc.by_location.slice(0,10).map((r,i) => ({name: r.location_name||r.location_id, value: parseInt(r.headcount), itemStyle: {color: CONFIG.colors[i%CONFIG.colors.length]}})), label: { color: '#94a3b8', fontSize: 11 } }]
        });
    }

    if (hc.by_department) {
        const depts = hc.by_department.slice(0,20).reverse();
        makeChart('chart-hc-dept', {
            tooltip: { trigger: 'axis' },
            yAxis: { type: 'category', data: depts.map(r => (r.department_name||r.sup_org_id||'').slice(0,30)), axisLabel: { color: '#64748b', fontSize: 11 } },
            xAxis: { type: 'value', axisLabel: { color: '#64748b' }, splitLine: { lineStyle: { color: '#1e3a4f' } } },
            series: [{ type: 'bar', data: depts.map((r,i) => ({value: parseInt(r.headcount), itemStyle: {color: CONFIG.colors[i%CONFIG.colors.length]}})) }],
            grid: { left: 200, right: 40, bottom: 20, top: 20 }
        });
    }

    if (hc.trend) {
        const dates = hc.trend.map(r => r.snapshot_date?.slice(0,7) || r.month);
        const vals = hc.trend.map(r => parseInt(r.headcount));
        makeChart('chart-hc-trend2', {
            tooltip: { trigger: 'axis' },
            xAxis: { type: 'category', data: dates, axisLabel: { color: '#64748b', rotate: 45 } },
            yAxis: { type: 'value', axisLabel: { color: '#64748b' }, splitLine: { lineStyle: { color: '#1e3a4f' } } },
            series: [{ type: 'line', data: vals, smooth: true, areaStyle: { color: new echarts.graphic.LinearGradient(0,0,0,1,[{offset:0,color:'rgba(59,130,246,0.3)'},{offset:1,color:'rgba(59,130,246,0)'}]) }, lineStyle: { color: '#3b82f6', width: 2 }, itemStyle: { color: '#3b82f6' }, markLine: { data: [{ type: 'average', label: { color: '#64748b' } }], lineStyle: { color: '#64748b', type: 'dashed' } } }],
            grid: { left: 60, right: 20, bottom: 60, top: 20 }
        });
    }
}

// ---- Movements ----
function renderMovements() {
    const mv = dashboardData.movements;
    if (!mv) return;
    const t = mv.by_type || {};
    document.getElementById('mv-kpi-cards').innerHTML = [
        kpiCard('Hires', fmt(t.hires)),
        kpiCard('Terminations', fmt(t.terminations), `Vol: ${fmt(t.voluntary_terminations)} | Invol: ${fmt(t.involuntary_terminations)}`),
        kpiCard('Promotions', fmt(t.promotions)),
        kpiCard('Pay Changes', fmt(t.pay_changes)),
    ].join('');

    // Movement types bar
    const types = [
        {name:'Hires',val:t.hires,color:'#10b981'}, {name:'Terminations',val:t.terminations,color:'#f43f5e'},
        {name:'Promotions',val:t.promotions,color:'#f59e0b'}, {name:'Job Changes',val:t.job_changes,color:'#3b82f6'},
        {name:'Pay Changes',val:t.pay_changes,color:'#8b5cf6'}, {name:'Lateral Moves',val:t.lateral_moves,color:'#06b6d4'},
        {name:'Grade Changes',val:t.grade_changes,color:'#14b8a6'}, {name:'Demotions',val:t.demotions,color:'#f97316'},
    ].filter(x => x.val > 0).sort((a,b) => b.val - a.val);
    makeChart('chart-mv-types', {
        tooltip: { trigger: 'axis' },
        yAxis: { type: 'category', data: types.map(x=>x.name).reverse(), axisLabel: { color: '#64748b' } },
        xAxis: { type: 'value', axisLabel: { color: '#64748b' }, splitLine: { lineStyle: { color: '#1e3a4f' } } },
        series: [{ type: 'bar', data: types.map(x=>({value:parseInt(x.val||0),itemStyle:{color:x.color}})).reverse() }],
        grid: { left: 120, right: 40, bottom: 20, top: 10 }
    });

    // Termination reasons
    if (mv.terminations?.length) {
        const terms = mv.terminations.slice(0,10).reverse();
        makeChart('chart-mv-terms', {
            tooltip: { trigger: 'axis' },
            yAxis: { type: 'category', data: terms.map(r=>(r.primary_termination_reason||'').replace(/^(VOL|INV|TER)-/,'')), axisLabel: { color: '#64748b', fontSize: 11 } },
            xAxis: { type: 'value', axisLabel: { color: '#64748b' }, splitLine: { lineStyle: { color: '#1e3a4f' } } },
            series: [{ type: 'bar', data: terms.map((r,i) => ({value:parseInt(r.cnt), itemStyle:{color: (r.primary_termination_reason||'').startsWith('VOL') ? '#f59e0b' : (r.primary_termination_reason||'').startsWith('INV') ? '#f43f5e' : '#64748b'}})) }],
            grid: { left: 130, right: 40, bottom: 20, top: 10 }
        });
    }

    // Monthly trend
    if (mv.monthly_trend?.length) {
        const m = mv.monthly_trend;
        makeChart('chart-mv-trend', {
            tooltip: { trigger: 'axis' },
            legend: { data: ['Hires','Terminations','Net Change'], textStyle: { color: '#94a3b8' }, top: 0 },
            xAxis: { type: 'category', data: m.map(r=>r.month), axisLabel: { color: '#64748b', rotate: 45 } },
            yAxis: { type: 'value', axisLabel: { color: '#64748b' }, splitLine: { lineStyle: { color: '#1e3a4f' } } },
            series: [
                { name: 'Hires', type: 'bar', data: m.map(r=>parseInt(r.hires||0)), itemStyle: { color: '#10b981' } },
                { name: 'Terminations', type: 'bar', data: m.map(r=>parseInt(r.terminations||0)), itemStyle: { color: '#f43f5e' } },
                { name: 'Net Change', type: 'line', data: m.map(r=>parseInt(r.hires||0)-parseInt(r.terminations||0)), lineStyle: { color: '#3b82f6', width: 2 }, itemStyle: { color: '#3b82f6' } },
            ],
            grid: { left: 60, right: 20, bottom: 60, top: 40 }
        });
    }

    // Rates trend
    if (mv.rates?.length) {
        makeChart('chart-mv-rates', {
            tooltip: { trigger: 'axis' },
            legend: { data: ['Turnover Rate','Promotion Rate'], textStyle: { color: '#94a3b8' }, top: 0 },
            xAxis: { type: 'category', data: mv.rates.map(r=>r.month), axisLabel: { color: '#64748b', rotate: 45 } },
            yAxis: { type: 'value', axisLabel: { color: '#64748b', formatter: '{value}%' }, splitLine: { lineStyle: { color: '#1e3a4f' } } },
            series: [
                { name: 'Turnover Rate', type: 'line', data: mv.rates.map(r=>parseFloat(r.turnover_rate||0)), smooth: true, lineStyle: { color: '#f43f5e' }, itemStyle: { color: '#f43f5e' }, areaStyle: { color: 'rgba(244,63,94,0.1)' } },
                { name: 'Promotion Rate', type: 'line', data: mv.rates.map(r=>parseFloat(r.promotion_rate||0)), smooth: true, lineStyle: { color: '#10b981' }, itemStyle: { color: '#10b981' }, areaStyle: { color: 'rgba(16,185,129,0.1)' } },
            ],
            grid: { left: 60, right: 20, bottom: 60, top: 40 }
        });
    }
}

// ---- Compensation ----
function renderCompensation() {
    const comp = dashboardData.compensation;
    if (!comp) return;

    const grades = comp.by_grade || [];
    const families = comp.by_job_family || [];
    const allPay = grades.map(r => parseFloat(r.avg_pay || 0)).filter(x => x > 0);
    const avgPay = allPay.length ? Math.round(allPay.reduce((a,b)=>a+b,0)/allPay.length) : 0;
    const medPay = allPay.length ? Math.round(allPay.sort((a,b)=>a-b)[Math.floor(allPay.length/2)]) : 0;

    document.getElementById('comp-kpi-cards').innerHTML = [
        kpiCard('Avg Base Pay', fmtPay(avgPay)),
        kpiCard('Median Base Pay', fmtPay(medPay)),
        kpiCard('Grades', grades.length),
        kpiCard('Job Families', families.length),
    ].join('');

    if (families.length) {
        const f = families.slice(0,15).reverse();
        makeChart('chart-comp-family', {
            tooltip: { trigger: 'axis', formatter: p => `${p[0].name}<br/>Avg Pay: $${parseInt(p[0].value).toLocaleString()}<br/>Workers: ${(f[f.length-1-p[0].dataIndex]?.worker_count||'—')}` },
            yAxis: { type: 'category', data: f.map(r=>(r.job_family||r.job_profile_id||'').slice(0,35)), axisLabel: { color: '#64748b', fontSize: 11 } },
            xAxis: { type: 'value', axisLabel: { color: '#64748b', formatter: v => '$'+fmt(v) }, splitLine: { lineStyle: { color: '#1e3a4f' } } },
            series: [{ type: 'bar', data: f.map((r,i) => ({value: parseFloat(r.avg_pay), itemStyle: {color: CONFIG.colors[i%CONFIG.colors.length]}})) }],
            grid: { left: 220, right: 60, bottom: 20, top: 10 }
        });
    }

    if (grades.length) {
        const g = grades.sort((a,b) => (a.grade_name||'').localeCompare(b.grade_name||''));
        makeChart('chart-comp-grade', {
            tooltip: { trigger: 'axis' },
            legend: { data: ['Min','Average','Max'], textStyle: { color: '#94a3b8' }, top: 0 },
            xAxis: { type: 'category', data: g.map(r=>r.grade_name||r.grade_id), axisLabel: { color: '#64748b', rotate: 30 } },
            yAxis: { type: 'value', axisLabel: { color: '#64748b', formatter: v => '$'+fmt(v) }, splitLine: { lineStyle: { color: '#1e3a4f' } } },
            series: [
                { name: 'Max', type: 'bar', stack: 'range', data: g.map(r => parseFloat(r.max_pay||0) - parseFloat(r.avg_pay||0)), itemStyle: { color: 'rgba(59,130,246,0.2)' } },
                { name: 'Average', type: 'bar', stack: 'range', data: g.map(r => parseFloat(r.avg_pay||0) - parseFloat(r.min_pay||0)), itemStyle: { color: 'rgba(59,130,246,0.5)' } },
                { name: 'Min', type: 'bar', stack: 'range', data: g.map(r => parseFloat(r.min_pay||0)), itemStyle: { color: 'rgba(59,130,246,0.15)' } },
            ],
            grid: { left: 80, right: 20, bottom: 60, top: 40 }
        });
    }
}

// ---- Org Health ----
function renderOrgHealth() {
    const oh = dashboardData.orgHealth;
    if (!oh) return;

    if (oh.departments?.length) {
        const d = oh.departments.slice(0,20).reverse();
        makeChart('chart-org-depts', {
            tooltip: { trigger: 'axis' },
            yAxis: { type: 'category', data: d.map(r=>(r.department_name||r.dept_id||'').slice(0,30)), axisLabel: { color: '#64748b', fontSize: 11 } },
            xAxis: { type: 'value', axisLabel: { color: '#64748b' }, splitLine: { lineStyle: { color: '#1e3a4f' } } },
            series: [{ type: 'bar', data: d.map((r,i) => ({value: parseInt(r.worker_count), itemStyle: {color: CONFIG.colors[i%CONFIG.colors.length]}})) }],
            grid: { left: 200, right: 40, bottom: 20, top: 10 }
        });
    }

    if (oh.span_distribution?.length) {
        makeChart('chart-org-span', {
            tooltip: { trigger: 'item' },
            series: [{ type: 'pie', radius: ['30%','60%'], data: oh.span_distribution.map((r,i) => ({name: r.span_range + ' reports', value: parseInt(r.manager_count), itemStyle: {color: CONFIG.colors[i]}})), label: { color: '#94a3b8', formatter: '{b}\n{c} ({d}%)' } }]
        });
    }

    if (oh.locations?.length) {
        const locs = oh.locations.slice(0,15).reverse();
        makeChart('chart-org-locs', {
            tooltip: { trigger: 'axis' },
            yAxis: { type: 'category', data: locs.map(r=>r.location_name||r.location_id), axisLabel: { color: '#64748b' } },
            xAxis: { type: 'value', axisLabel: { color: '#64748b' }, splitLine: { lineStyle: { color: '#1e3a4f' } } },
            series: [{ type: 'bar', data: locs.map((r,i) => ({value: parseInt(r.worker_count||r.headcount), itemStyle: {color: CONFIG.colors[i%CONFIG.colors.length]}})) }],
            grid: { left: 130, right: 40, bottom: 20, top: 10 }
        });
    }

    if (oh.worker_status?.length) {
        const statusColors = { 'Active': '#10b981', 'On Leave': '#f59e0b', 'Terminated': '#f43f5e', 'Leave': '#f59e0b' };
        makeChart('chart-org-status', {
            tooltip: { trigger: 'item' },
            series: [{ type: 'pie', radius: ['30%','60%'], data: oh.worker_status.map(r => ({name: r.worker_status, value: parseInt(r.worker_count), itemStyle: {color: statusColors[r.worker_status] || '#64748b'}})), label: { color: '#94a3b8', formatter: '{b}\n{c} ({d}%)' } }]
        });
    }
}

// ============================================================
// Tab Navigation
// ============================================================
document.querySelectorAll('.nav-tab').forEach(tab => {
    tab.addEventListener('click', () => {
        document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
        tab.classList.add('active');
        document.getElementById('tab-' + tab.dataset.tab).classList.add('active');
        // Resize charts after tab switch
        setTimeout(() => { Object.values(CONFIG.charts).forEach(c => c.resize()); }, 100);
    });
});

// Window resize
window.addEventListener('resize', () => { Object.values(CONFIG.charts).forEach(c => c.resize()); });

// Timestamp
function updateTime() { document.getElementById('timestamp').textContent = new Date().toLocaleString(); }
updateTime(); setInterval(updateTime, 1000);

// Auto-refresh
setInterval(loadData, CONFIG.refreshInterval);

// Initial load
loadData();
</script>
</body>
</html>
